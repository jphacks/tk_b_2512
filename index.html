<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ozendate - AIテーブルコーディネート プロトタイプ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #FDFBF8;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8C5E4A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #image-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        #image-container.dimmed::after {
            opacity: 1;
        }
        .recommendation-card {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .recommendation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }
        .recommendation-card.selected {
             border-color: #8C5E4A;
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* 横スクロールバーのスタイル */
        #recommendations-container::-webkit-scrollbar { height: 8px; }
        #recommendations-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #recommendations-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        #recommendations-container::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-[#8C5E4A]">ozendate</h1>
            <p class="text-gray-600 mt-2">AIテーブルコーディネートをもっと楽しく！</p>
        </header>

        <!-- Step 1: Upload Section -->
        <section id="upload-section" class="text-center">
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 md:p-12 cursor-pointer hover:bg-gray-50 transition" onclick="document.getElementById('image-uploader').click()">
                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>
                <p class="mt-4 font-semibold text-gray-700">テーブルの写真をアップロード</p>
                <p class="mt-1 text-sm text-gray-500">クリックしてファイルを選択</p>
            </div>
            <input type="file" id="image-uploader" class="hidden" accept="image/*">
        </section>

        <!-- Step 2: Editor Section -->
        <section id="editor-section" class="hidden">
            <div id="instruction" class="bg-amber-50 text-amber-800 p-3 rounded-lg text-center mb-4 text-sm font-medium">
                <p id="instruction-text">1. 新しい食器を置きたい場所をクリックしてください。</p>
            </div>

            <div id="image-container" class="relative rounded-lg overflow-hidden cursor-crosshair shadow-md mx-auto max-w-2xl">
                <img id="uploaded-image" src="#" alt="Uploaded table" class="w-full h-auto">
            </div>

            <div id="recommendations" class="hidden mt-6">
                 <h2 class="text-lg font-semibold mb-3 text-center text-gray-700">AIのおすすめ</h2>
                 <div id="recommendations-container" class="flex space-x-4 overflow-x-auto pb-4">
                    <!-- Recommendation items will be injected by JS -->
                 </div>
            </div>
        </section>

        <!-- Step 3: Loading Section -->
        <section id="loading-section" class="hidden text-center py-12">
            <div class="loader mx-auto"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-600">AIが画像を生成中です...</p>
            <p class="text-sm text-gray-500">素晴らしいコーディネートを準備しています</p>
        </section>

        <!-- Step 4: Result Section -->
        <section id="result-section" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">✨ 完成です！ ✨</h2>
            <img id="result-image" src="#" alt="Generated coordinate" class="rounded-lg shadow-lg w-full max-w-2xl mx-auto">
            <button id="reset-button" class="mt-6 bg-[#8C5E4A] hover:bg-[#754f3d] text-white font-bold py-2 px-6 rounded-full transition">
                もう一度試す
            </button>
        </section>

        <!-- Error Modal -->
        <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl text-center max-w-sm">
                <h3 class="text-lg font-bold text-red-600">エラーが発生しました</h3>
                <p id="error-message" class="mt-2 text-sm text-gray-600"></p>
                <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <script>
        const uploadSection = document.getElementById('upload-section');
        const editorSection = document.getElementById('editor-section');
        const loadingSection = document.getElementById('loading-section');
        const resultSection = document.getElementById('result-section');

        const imageUploader = document.getElementById('image-uploader');
        const uploadedImage = document.getElementById('uploaded-image');
        const imageContainer = document.getElementById('image-container');
        const recommendations = document.getElementById('recommendations');
        const recommendationsContainer = document.getElementById('recommendations-container');
        const resultImage = document.getElementById('result-image');

        const resetButton = document.getElementById('reset-button');
        const instructionText = document.getElementById('instruction-text');
        const loadingText = document.getElementById('loading-text');
        
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');

        let originalImageBase64 = '';
        let placementMarker = null;
        let selectedDish = null;

        // --- Event Listeners ---
        imageUploader.addEventListener('change', handleImageUpload);
        imageContainer.addEventListener('click', handleImageClick);
        resetButton.addEventListener('click', resetApp);
        
        // --- Functions ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImageBase64 = e.target.result;
                    uploadedImage.src = originalImageBase64;
                    uploadSection.classList.add('hidden');
                    editorSection.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function handleImageClick(event) {
            // Only proceed if we haven't started showing recommendations yet
            if (!recommendations.classList.contains('hidden')) {
                return;
            }
        
            const rect = imageContainer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            if (placementMarker) {
                placementMarker.remove();
            }

            placementMarker = document.createElement('div');
            placementMarker.style.position = 'absolute';
            placementMarker.style.left = `${x - 15}px`;
            placementMarker.style.top = `${y - 15}px`;
            placementMarker.style.width = '30px';
            placementMarker.style.height = '30px';
            placementMarker.style.border = '3px solid #8C5E4A';
            placementMarker.style.borderRadius = '50%';
            placementMarker.style.backgroundColor = 'rgba(140, 94, 74, 0.3)';
            placementMarker.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
            placementMarker.style.pointerEvents = 'none';
            imageContainer.appendChild(placementMarker);
            
            // New flow: get AI recommendations
            getAiDishRecommendations();
        }

        async function getAiDishRecommendations() {
            instructionText.textContent = 'AIがあなたにおすすめの食器を考えています...';
            recommendations.classList.remove('hidden');
            recommendationsContainer.innerHTML = `<div class="w-full flex justify-center py-8"><div class="loader"></div></div>`;
            imageContainer.style.cursor = 'default';

            const prompt = `Analyze the attached image of a table setting. A user wants to place a new item. Suggest 5 diverse types of tableware (like 'a small blue ceramic bowl', 'a rustic wooden plate', 'a modern glass cup') that would complement the existing items in terms of style, color, and occasion. Provide the response as a valid JSON array of objects, where each object has a 'name_ja' (Japanese name) and a 'name_en' (English name for the image generation prompt).`;
            const base64Data = originalImageBase64.split(',')[1];
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name_ja": { "type": "STRING" },
                                "name_en": { "type": "STRING" }
                            },
                            required: ["name_ja", "name_en"]
                        }
                    }
                }
            };

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error (${response.status}): ${await response.text()}`);
                }
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const recommendedDishes = JSON.parse(jsonText);
                
                displayRecommendations(recommendedDishes);

            } catch (error) {
                console.error("Failed to get AI recommendations:", error);
                showError(`AIによる提案の取得に失敗しました。${error.message}`);
                recommendationsContainer.innerHTML = `<p class="text-red-500 text-center w-full">提案の取得に失敗しました。</p>`;
            }
        }

        function displayRecommendations(dishes) {
            instructionText.textContent = '2. AIの提案から追加したい食器を選んでください。';
            recommendationsContainer.innerHTML = ''; // Clear loader
            
            dishes.forEach(dish => {
                const card = document.createElement('div');
                card.className = 'recommendation-card w-40 flex-shrink-0 bg-white p-3 rounded-xl shadow-md cursor-pointer border';
                // Using placeholder images based on the dish name
                const placeholderImg = `https://placehold.co/200x200/EAE5DB/333333?text=${encodeURIComponent(dish.name_ja)}`;
                card.innerHTML = `
                    <img src="${placeholderImg}" alt="${dish.name_ja}" class="w-full h-24 object-cover rounded-md mx-auto">
                    <p class="text-xs font-semibold mt-2 text-center">${dish.name_ja}</p>
                `;
                card.onclick = (event) => selectDish(dish, event.currentTarget);
                recommendationsContainer.appendChild(card);
            });
        }

        function selectDish(dish, selectedCard) {
             if(selectedDish) return; // Prevent multiple selections

            selectedDish = dish;
            imageContainer.classList.add('dimmed');
            
            document.querySelectorAll('.recommendation-card').forEach(c => {
                c.style.opacity = '0.6';
                c.style.pointerEvents = 'none';
            });
            selectedCard.style.opacity = '1';
            selectedCard.classList.add('selected');

            setTimeout(generateImage, 500);
        }

        async function generateImage() {
            if (!originalImageBase64 || !selectedDish || !placementMarker) {
                showError("画像、配置場所、食器が選択されていません。");
                return;
            }

            editorSection.classList.add('hidden');
            loadingText.textContent = 'AIが画像を生成中です...';
            loadingSection.classList.remove('hidden');
            
            const rect = uploadedImage.getBoundingClientRect();
            const markerRect = placementMarker.getBoundingClientRect();
            
            const relativeX = markerRect.left + markerRect.width / 2 - rect.left;
            const relativeY = markerRect.top + markerRect.height / 2 - rect.top;

            const percentX = (relativeX / rect.width) * 100;
            const percentY = (relativeY / rect.height) * 100;
            
            const prompt = `Photo of a table setting. Place ${selectedDish.name_en} on the table. The desired location for the new item is at the center of the provided mask area. The new item should blend in naturally with the existing lighting, shadows, and perspective. Maintain the original image's style and quality. Do not change anything else in the image.`;
            const base64Data = originalImageBase64.split(',')[1];
            
            // For now, we will use a simpler image generation API call as inpainting is complex.
            // The prompt asks the model to place the item at a percentage-based location.
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                }
            };
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                     const errorText = await response.text();
                     throw new Error(`API error (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                const generatedImageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (generatedImageData) {
                    const mimeType = result.candidates[0].content.parts.find(p => p.inlineData).inlineData.mimeType;
                    resultImage.src = `data:${mimeType};base64,${generatedImageData}`;
                    loadingSection.classList.add('hidden');
                    resultSection.classList.remove('hidden');
                } else {
                    console.error('API Response:', JSON.stringify(result, null, 2));
                    throw new Error("生成された画像データがAPIレスポンスに含まれていませんでした。");
                }

            } catch (error) {
                console.error("Image generation failed:", error);
                showError(`画像の生成に失敗しました。詳細: ${error.message}`);
                // Revert to editor state on failure
                loadingSection.classList.add('hidden');
                editorSection.classList.remove('hidden'); 
                resetToSelectionStep();
            }
        }
        
        function resetToSelectionStep() {
             imageContainer.classList.remove('dimmed');
             if(placementMarker) placementMarker.remove();
             placementMarker = null;
             recommendations.classList.add('hidden');
             recommendationsContainer.innerHTML = '';
             instructionText.textContent = '1. 新しい食器を置きたい場所をクリックしてください。';
             selectedDish = null;
             imageContainer.style.cursor = 'crosshair';
        }

        function resetApp() {
            originalImageBase64 = '';
            selectedDish = null;
            if (placementMarker) {
                placementMarker.remove();
                placementMarker = null;
            }

            imageUploader.value = '';
            uploadedImage.src = '#';
            resultImage.src = '#';
            imageContainer.classList.remove('dimmed');
            imageContainer.style.cursor = 'crosshair';
            
            resultSection.classList.add('hidden');
            editorSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            recommendations.classList.add('hidden');
            recommendationsContainer.innerHTML = '';
            uploadSection.classList.remove('hidden');
            instructionText.textContent = '1. 新しい食器を置きたい場所をクリックしてください。';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    // Don't retry on client-side errors, only server/rate-limit errors
                    if (response.status < 500 && response.status !== 429) { 
                        return response;
                    }
                    if (i === retries - 1) return response; // Return last failed response
                } catch (error) {
                    if (i === retries - 1) throw error;
                }
                await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
            }
            throw new Error("Max retries reached");
        }
    </script>
</body>
</html>
